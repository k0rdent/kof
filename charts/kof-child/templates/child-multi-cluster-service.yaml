{{- $global := .Values.global | default dict }}
{{- $globalValues := .Values.globalValues | fromYaml }}
{{- $customRegistry := or $global.registry $globalValues.registry "" }}
{{- if eq $customRegistry "docker.io" }}{{ $customRegistry = "" }}{{ end }}

{{- range $istio := list true false }}
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: MultiClusterService
metadata:
{{- if and ($istio) ($.Values.istio.enabled) }}
   name: kof-istio-child-cluster
{{- else }}
  name: kof-child-cluster
{{- end }}
spec:
  clusterSelector:
    matchLabels:
      k0rdent.mirantis.com/kof-cluster-role: child
    {{- if and ($istio) ($.Values.istio.enabled) }}
      k0rdent.mirantis.com/istio-role: member
    {{- else }}
    matchExpressions:
      - key: "k0rdent.mirantis.com/istio-role"
        operator: DoesNotExist
    {{- end }}

  {{- if and ($istio) ($.Values.istio.enabled) }}
   {{- if $.Values.istio.dependsOn }}
  dependsOn:
  {{- range $.Values.istio.dependsOn }}
    - {{ . }}
  {{- end }}
  {{- end }}
  {{- end }}

  serviceSpec:
    services:
      {{- $version := $.Chart.Version | replace "." "-" }}

      {{- if and (not $istio) (index $.Values "cert-manager" "enabled") }}
      - name: cert-manager
        namespace: {{ $.Release.Namespace }}
        template: {{ index $.Values "cert-manager" "template" }}
        helmOptions:
          wait: true
        values: |
          crds:
            enabled: true
        {{- with $customRegistry }}
          image:
            repository: {{ . }}/jetstack/cert-manager-controller
          acmesolver:
            image:
              repository: {{ . }}/jetstack/cert-manager-acmesolver
          cainjector:
            image:
              repository: {{ . }}/jetstack/cert-manager-cainjector
          startupapicheck:
            image:
              repository: {{ . }}/jetstack/cert-manager-startupapicheck
          webhook:
            image:
              repository: {{ . }}/jetstack/cert-manager-webhook
        {{- end }}
      {{- end }}

      {{- $dependsOnList := list }}
      {{- if and (not $istio) (index $.Values "cert-manager" "enabled") }}
        {{- $dependsOnList = append $dependsOnList (dict "name" "cert-manager" "namespace" $.Release.Namespace) }}
      {{- end }}

      - name: kof-operators
        namespace: {{ $.Release.Namespace }}
        template: kof-operators-{{ $version }}
        templateChain: kof-operators-{{ $version }}
        helmOptions:
          wait: true
        {{- if gt (len $dependsOnList) 0 }}
        dependsOn:
        {{- toYaml $dependsOnList | nindent 10 }}
        {{- end }}
        values: |
          {{`{{ $operatorsValuesFromAnnotation := index .Cluster.metadata.annotations "k0rdent.mirantis.com/kof-operators-values" | default "{}" | fromYaml }}`}}
          {{`{{`}} $operatorsValuesFromHelm := `{{ $.Values.operators | toYaml | nindent 10 }}` | fromYaml {{`}}`}}
          {{`{{`}} $globalValuesFromHelm := `{{ $globalValues | toYaml | nindent 10 }}` | fromYaml {{`}}`}}
          {{`{{ mergeOverwrite (dict) $globalValuesFromHelm $operatorsValuesFromHelm $operatorsValuesFromAnnotation | toYaml | nindent 4 }}`}}

      - name: kof-collectors
        namespace: {{ $.Release.Namespace }}
        template: kof-collectors-{{ $version }}
        templateChain: kof-collectors-{{ $version }}
        helmOptions:
          wait: true
        dependsOn:
          - name: kof-operators
            namespace: {{ $.Release.Namespace }}
        values: |
          {{`{{ $vmuserHash := printf "kof-cluster-config-%s/%s" .Cluster.metadata.name .Cluster.metadata.namespace | adler32sum }}`}}
          {{`{{ $vmuserSecretName := printf "kof-vmuser-creds-%s" $vmuserHash }}`}}
        {{- if and ($istio) ($.Values.istio.enabled) }}
          {{`{{ $regionalClusterName := getField "ChildConfig" "data.regional_cluster_name" }}`}}
        {{- else }}
          {{`{{ $writeMetricsEndpoint := getField "ChildConfig" "data.write_metrics_endpoint" }}`}}
          {{`{{ $readMetricsEndpoint := getField "ChildConfig" "data.read_metrics_endpoint" }}`}}
          {{`{{ $logsEndpoint := getField "ChildConfig" "data.write_logs_endpoint" }}`}}
          {{`{{ $tracesEndpoint := getField "ChildConfig" "data.write_traces_endpoint" }}`}}
          {{`{{ $vmuserSecretVersion := getField "StorageVMUserCredentials" "metadata.resourceVersion" }}`}}
        {{- end }}
          {{`{{ $collectorsValuesFromAnnotation := index .Cluster.metadata.annotations "k0rdent.mirantis.com/kof-collectors-values" | default "{}" | fromYaml }}`}}
          {{`{{`}} $collectorsValuesFromHelm := `{{ $.Values.collectors | toYaml | nindent 10 }}` | fromYaml {{`}}`}}
          {{`{{`}} $collectorsValuesHere := `
          global:
            clusterName: {childClusterName}
            clusterNamespace: {childClusterNamespace}
          opentelemetry-kube-stack:
            clusterName: {childClusterName}
            collectors:
            {{- if and ($istio) ($.Values.istio.enabled) }}
              controller-k0s:
                enabled: false
            {{- end }}
              daemon:
              {{- if and ($istio) ($.Values.istio.enabled) }}
                hostNetwork: false
              {{- else }}
                hostNetwork: true
                observability:
                  metrics:
                    disablePrometheusAnnotations: false
                    enableMetrics: false
                podAnnotations:
                  prometheus.io/ip4: ${env:OTEL_K8S_NODE_IP}
              {{- end }}
                config:
                {{- if not $istio }}
                  receivers:
                    prometheus:
                      api_server:
                        server_config:
                          endpoint: ${env:OTEL_K8S_NODE_IP}:9090
                    otlp:
                      protocols:
                        grpc:
                          endpoint: 127.0.0.1:4317
                        http:
                          endpoint: 127.0.0.1:4318
                {{- end }}
                  service:
                    extensions:
                      - k8s_observer
                      - file_storage/filelogreceiver
                      - file_storage/filelogsyslogreceiver
                      - file_storage/filelogk8sauditreceiver
                      - file_storage/journaldreceiver
                      - basicauth/metrics
                      - basicauth/logs
                      - basicauth/traces
                    {{- if not $istio }}
                    telemetry:
                      metrics:
                        address: ${env:OTEL_K8S_NODE_IP}:8888
                        readers:
                          - pull:
                              exporter:
                                prometheus:
                                  host: ${env:OTEL_K8S_NODE_IP}
                                  port: 8888
                    {{- end }}
            defaultCRConfig:
              env:
                - name: KOF_VM_USER
                  valueFrom:
                    secretKeyRef:
                      key: username
                      name: {vmuserSecretName}
                - name: KOF_VM_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: password
                      name: {vmuserSecretName}
              podAnnotations:
                k0rdent.mirantis.com/kof-vmuser-secret-version: "{vmuserSecretVersion}"
              config:
                processors:
                  resource/k8sclustername:
                    attributes:
                    - action: insert
                      key: k8s.cluster.name
                      value: {childClusterName}
                    - action: insert
                      key: k8s.cluster.namespace
                      value: {childClusterNamespace}
                extensions:
                  basicauth/logs:
                    client_auth:
                      username: ${env:KOF_VM_USER}
                      password: ${env:KOF_VM_PASSWORD}
                  basicauth/metrics:
                    client_auth:
                      username: ${env:KOF_VM_USER}
                      password: ${env:KOF_VM_PASSWORD}
                  basicauth/traces:
                    client_auth:
                      username: ${env:KOF_VM_USER}
                      password: ${env:KOF_VM_PASSWORD}
                service:
                  extensions:
                  - basicauth/logs
                  - basicauth/metrics
                  - basicauth/traces
                exporters:
                  debug: {}
                  otlphttp/logs:
                  {{- if and ($istio) ($.Values.istio.enabled) }}
                    logs_endpoint: http://{regionalClusterName}-vmauth:8427/vli/insert/opentelemetry/v1/logs
                  {{- else }}
                    logs_endpoint: {logsEndpoint}
                  {{- end }}
                    auth:
                      authenticator: basicauth/logs
                  otlphttp/traces:
                  {{- if and ($istio) ($.Values.istio.enabled) }}
                    traces_endpoint: http://{regionalClusterName}-vmauth:8427/vti/insert/opentelemetry/v1/traces
                  {{- else }}
                    traces_endpoint: {tracesEndpoint}
                  {{- end }}
                    auth:
                      authenticator: basicauth/traces
                  prometheusremotewrite:
                  {{- if and ($istio) ($.Values.istio.enabled) }}
                    endpoint: http://{regionalClusterName}-vmauth:8427/vm/insert/0/prometheus/api/v1/write
                  {{- else }}
                    endpoint: {writeMetricsEndpoint}
                  {{- end }}
                    auth:
                      authenticator: basicauth/metrics
                    external_labels:
                      cluster: {childClusterName}
                      clusterNamespace: {childClusterNamespace}
          opencost:
            opencost:
              prometheus:
                existingSecretName: {vmuserSecretName}
                external:
                {{- if and ($istio) ($.Values.istio.enabled) }}
                  url: http://{regionalClusterName}-vmauth:8427/vm/select/0/prometheus
                {{- else }}
                  url: {readMetricsEndpoint}
                {{- end }}
              exporter:
                defaultClusterId: {childClusterName}
          ` | replace "{childClusterName}" .Cluster.metadata.name | replace "{childClusterNamespace}" .Cluster.metadata.namespace | replace "{vmuserSecretName}" $vmuserSecretName
          {{- if and ($istio) ($.Values.istio.enabled) }} | replace "{regionalClusterName}" $regionalClusterName
          {{- else }} | replace "{tracesEndpoint}" $tracesEndpoint | replace "{logsEndpoint}" $logsEndpoint | replace "{writeMetricsEndpoint}" $writeMetricsEndpoint | replace "{readMetricsEndpoint}" $readMetricsEndpoint | replace "{vmuserSecretVersion}" $vmuserSecretVersion
          {{- end }} | fromYaml {{`}}`}}
          {{`{{`}} $globalValuesFromHelm := `{{ $globalValues | toYaml | nindent 10 }}` | fromYaml {{`}}`}}
          {{`{{ mergeOverwrite (dict) $globalValuesFromHelm $collectorsValuesHere $collectorsValuesFromHelm $collectorsValuesFromAnnotation | toYaml | nindent 4 }}`}}
    templateResourceRefs:
    - identifier: ChildConfig
      resource:
        apiVersion: v1
        kind: ConfigMap
        name: kof-cluster-config-{{`{{ .Cluster.metadata.name }}`}}
        namespace: "{{`{{ .Cluster.metadata.namespace }}`}}"
    - identifier: ChildKCMCluster
      optional: true
      resource:
        apiVersion: cluster.x-k8s.io/v1beta1
        kind: Cluster
        name: "{{`{{ .Cluster.metadata.name }}`}}"
        namespace: "{{`{{ .Cluster.metadata.namespace }}`}}"
    - identifier: ChildSveltosCluster
      optional: true
      resource:
        apiVersion: lib.projectsveltos.io/v1beta1
        kind: SveltosCluster
        name: "{{`{{ .Cluster.metadata.name }}`}}"
        namespace: "{{`{{ .Cluster.metadata.namespace }}`}}"
    - identifier: StorageVMUserCredentials
      optional: true
      resource:
        apiVersion: v1
        kind: Secret
        name: kof-vmuser-creds-{{`{{ (printf "kof-cluster-config-%s/%s" .Cluster.metadata.name .Cluster.metadata.namespace) | adler32sum }}`}}
        namespace: {{ $.Release.Namespace }}
{{ end }}
