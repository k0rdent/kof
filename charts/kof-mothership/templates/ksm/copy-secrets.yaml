{{- range $name, $value := .Values.kcm.kof.mcs }}
{{- /* Distributing secrets to clusters automatically*/}}

---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: ServiceTemplate
metadata:
  name: {{ $name }}-remote-template
  namespace: {{ $.Values.kcm.namespace }}
spec:
  resources:
    localSourceRef:
      kind: ConfigMap
      name: {{ $name }}-remote-secret-templates
      namespace: {{ $.Values.kcm.namespace }}
    deploymentType: Remote
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: ServiceTemplate
metadata:
  name: {{ $name }}-local-template
  namespace: {{ $.Values.kcm.namespace }}
spec:
  resources:
    localSourceRef:
      kind: ConfigMap
      name: {{ $name }}-cluster-namespace-secret-template
      namespace: {{ $.Values.kcm.namespace }}
    deploymentType: Local
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $name }}-cluster-namespace-secret-template
  namespace: {{ $.Values.kcm.namespace }}
  annotations:
    projectsveltos.io/template: "true"
data:
  {{- range $value.secrets }}
  secret-{{ . }}.yaml: |
    {{`{{`}} setField "secret-{{ . }}" "metadata.namespace" $.Cluster.metadata.namespace {{`}}`}}
  {{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $name }}-remote-secret-templates
  namespace: {{ $.Values.kcm.namespace }}
  annotations:
    projectsveltos.io/template: "true"
data:
  {{- range $value.secrets }}
  secret-{{ . }}.yaml: |
    {{`{{`}} setField "secret-{{ . }}" "metadata.namespace" "{{ $.Release.Namespace }}" {{`}}`}}
  {{- end }}
{{/* This MultiClusterService is responsible for copying secrets across clusters */}}
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: MultiClusterService
metadata:
  name: {{ $name }}-remote
spec:
  clusterSelector:
    matchLabels: {{ $value.matchLabels | toYaml | nindent 6 }}
  serviceSpec:
    services:
    - name: remote-secrets
      template: {{ $name }}-remote-template
      namespace: {{ $.Release.Namespace }}
    templateResourceRefs:
      {{- range $value.secrets }}
      - identifier: secret-{{ . }}
        resource:
          apiVersion: v1
          kind: Secret
          name: {{ . }}
          namespace: {{ $.Release.Namespace }}
      {{- end }}
    syncMode: Continuous
{{/* This MCS copies secrets from the management cluster into the target cluster's namespace. */}}
{{/* It is required for each ClusterDeployment that has associated GrafanaDatasources, */}}
{{/* since those datasources need the secret to exist in the same namespace as the cluster. */}}
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: MultiClusterService
metadata:
  name: {{ $name }}-local
spec:
  clusterSelector:
    matchLabels: {{ $value.matchLabels | toYaml | nindent 6 }}
  serviceSpec:
    provider:
      selfManagement: true
    services:
    - name: local-secrets
      template: {{ $name }}-local-template
    templateResourceRefs:
      {{- range $value.secrets }}
      - identifier: secret-{{ . }}
        resource:
          apiVersion: v1
          kind: Secret
          name: {{ . }}
          namespace: {{ $.Release.Namespace }}
      {{- end }}
    syncMode: Continuous
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: ServiceTemplate
metadata:
  name: {{ $name }}-copy-template
  namespace: {{ $.Values.kcm.namespace }}
spec:
  resources:
    localSourceRef:
      kind: ConfigMap
      name: {{ $name }}-copy-template
      namespace: {{ $.Values.kcm.namespace }}
    deploymentType: Remote
---
apiVersion: k0rdent.mirantis.com/v1beta1
kind: MultiClusterService
metadata:
  name: {{ $name }}-remote-templates-copy
spec:
  clusterSelector:
    matchLabels:
      k0rdent.mirantis.com/kcm-region-cluster: "true"
  serviceSpec:
    services:
    - name: remote-templates-copy
      template: {{ $name }}-copy-template
      namespace: {{ $.Values.kcm.namespace }}
    templateResourceRefs:
    - identifier: template-remote
      resource:
        apiVersion: v1
        kind: ConfigMap
        name: {{ $name }}-remote-secret-templates
        namespace: {{ $.Values.kcm.namespace  }}
---
{{/* TODO: Remove these resources once KCM implements automatic propagation of required resources to regional clusters. */}}
{{/* These resources define a MultiClusterService that copies secret templates to KCM region clusters. */}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $name }}-copy-template
  namespace: {{ $.Values.kcm.namespace }}
  annotations:
    projectsveltos.io/template: "true"
data:
  template-remote.yaml: |
    {{`{{`}} copy "template-remote" {{`}}`}}

{{- end }}
